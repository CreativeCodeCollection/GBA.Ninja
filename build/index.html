<!DOCTYPE html>
<html>
    <head>
        
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
        
        <title>gba.ninja</title>
        
        <style>
            html, body {
                width:  100%;
                height: 100%;
                margin: 0px;
                background-color: white;
            }
            canvas {
                right: 0px;
                left: 0px;
                bottom: 0px;
                top: 0px;
                position: absolute;
                width: 100%;
                height: 100%;
            }
        </style>
        
        
        <script id="2d-vertex-shader" type="x-shader/x-vertex">
            attribute vec2 a_position;
            varying highp vec2 v_textureCoord;

            void main() {
                /* 
                 * This scales the quad so that the screen texture fits the viewport.
                 * The texture is 256 * 256, but only 240 * 160 is used. The quad is 2*2, centered on (0,0)
                 */
                gl_Position = vec4((a_position.x * 2.0 * 1.0666) - 1.0, (a_position.y * 2.0 * 1.6) * -1.0 + 1.0, 0, 1);
                v_textureCoord = vec2(a_position.x, a_position.y);
            }
        </script>

        <script id="2d-fragment-shader" type="x-shader/x-fragment">
            varying highp vec2 v_textureCoord;

            uniform sampler2D u_sampler;

            void main(void) {
                gl_FragColor = texture2D(u_sampler, vec2(v_textureCoord.s, v_textureCoord.t));
            }
        </script>
        
        <script>
            
            // Disable backspace navigation
            var backspaceHandler = function (e) {
                if (e.which === 8) {
                    if (!/INPUT|SELECT|TEXTAREA/i.test(e.target.tagName) || e.target.disabled || e.target.readOnly) {
                        e.preventDefault();
                    }
                }
            }.bind(this);
            document.addEventListener("keydown", backspaceHandler);
            document.addEventListener("keypress", backspaceHandler);
            
            
            // Shim performance.now
            window.performance = window.performance || {};
            performance.now = (function () {
                return performance.now    ||
                    performance.mozNow    ||
                    performance.msNow     ||
                    performance.oNow      ||
                    performance.webkitNow ||
                    function() {
                        return new Date().getTime(); 
                    };
            })();
            
            
            // Shim localstorage
            if (!window.localStorage) {
                window.localStorage = {};
            }
            
            var readyHandlers = {};
            var onReady = function (what, fn) {
                if (readyHandlers[what] === null) {
                    setTimeout(function () {fn();});
                    return;
                }
                if (readyHandlers[what] === void 0) {
                    readyHandlers[what] = [];
                }
                readyHandlers[what].push(fn);
            };
            var triggerReady = function (what) {
                if (readyHandlers[what]) {
                    readyHandlers[what].forEach(function (v) {
                        v();
                    });
                }
                readyHandlers[what] = null;
            };
            
            
            
            
            
            var romBuffer8 = null;
            window.loadRomFromFile = function (e) {
                
                var binaryFile = e.currentTarget.files[0];
                var fr = new FileReader();
                if (FileReader && binaryFile) {
                    fr.readAsArrayBuffer(binaryFile);
                    fr.onload = function () {
                        romBuffer8 = new Uint8Array(fr.result);
                        triggerReady("cartridge");
                    }.bind(this);
                }
                
            };
            
            
            window.Module = {
                onRuntimeInitialized: function() {
                    triggerReady("emu");
                },
            };
            
            
            document.addEventListener("DOMContentLoaded", function () {
                triggerReady("document");
            });
            
            
            onReady("emu", function () {
                onReady("document", function () {
                    window.init();
                });
            });
            
            
            // ------ VBA ENTRY POINTS -------
            
            var VBAInterface = {};
            
            VBAInterface.VBA_get_emulating = function () {
                return Module.ccall("VBA_get_emulating", "int", [], []);
            };
            
            VBAInterface.VBA_start = function () {
                return Module.ccall("VBA_start", "int", [], []);
            };
            
            VBAInterface.VBA_do_cycles = function (cycles) {
                return Module.ccall("VBA_do_cycles", "int", ["int"], [cycles]);
            };
            
            VBAInterface.VBA_stop = function () {
                return Module.ccall("VBA_stop", "int", [], []);
            };
            
            VBAInterface.VBA_get_bios = function () {
                return Module.ccall("VBA_get_bios", "int", [], []);
            };
            
            VBAInterface.VBA_get_rom = function () {
                return Module.ccall("VBA_get_rom", "int", [], []);
            };
            
            VBAInterface.VBA_get_internalRAM = function () {
                return Module.ccall("VBA_get_internalRAM", "int", [], []);
            };
            
            VBAInterface.VBA_get_workRAM = function () {
                return Module.ccall("VBA_get_workRAM", "int", [], []);
            };
            
            VBAInterface.VBA_get_paletteRAM = function () {
                return Module.ccall("VBA_get_paletteRAM", "int", [], []);
            };
            
            VBAInterface.VBA_get_vram = function () {
                return Module.ccall("VBA_get_vram", "int", [], []);
            };
            
            VBAInterface.VBA_get_pix = function () {
                return Module.ccall("VBA_get_pix", "int", [], []);
            };
            
            VBAInterface.VBA_get_oam = function () {
                return Module.ccall("VBA_get_oam", "int", [], []);
            };
            
            VBAInterface.VBA_get_ioMem = function () {
                return Module.ccall("VBA_get_ioMem", "int", [], []);
            };
            
            VBAInterface.VBA_get_systemColorMap16 = function () {
                return Module.ccall("VBA_get_systemColorMap16", "int", [], []);
            };
            
            VBAInterface.VBA_get_systemColorMap32 = function () {
                return Module.ccall("VBA_get_systemColorMap32", "int", [], []);
            };
            
            VBAInterface.VBA_get_systemFrameSkip = function () {
                return Module.ccall("VBA_get_systemFrameSkip", "int", [], []);
            };
            
            VBAInterface.VBA_set_systemFrameSkip = function (n) {
                return Module.ccall("VBA_set_systemFrameSkip", "int", ["int"], [n]);
            };
            
            VBAInterface.VBA_get_systemSaveUpdateCounter = function () {
                return Module.ccall("VBA_get_systemSaveUpdateCounter", "int", [], []);
            };
            
            VBAInterface.VBA_reset_systemSaveUpdateCounter = function () {
                return Module.ccall("VBA_reset_systemSaveUpdateCounter", "int", [], []);
            };
            
            VBAInterface.VBA_emuWriteBattery = function () {
                return Module.ccall("VBA_emuWriteBattery", "int", [], []);
            };
            
            VBAInterface.VBA_agbPrintFlush = function () {
                return Module.ccall("VBA_agbPrintFlush", "int", [], []);
            };
            
            
            
            
            // ------- VBA EXIT POINTS --------
            
            VBAInterface.NYI = function (feature) {
                console.log("Feature is NYI: ", feature);
            };
            
            VBAInterface.getAudioSampleRate = function () {
                return window.vbaSound.getSampleRate();
            };
            
            VBAInterface.getRomSize = function (startPointer8) {
                return romBuffer8.byteLength;
            };
            
            VBAInterface.copyRomToMemory = function (startPointer8) {
                var gbaHeap8 = Module.HEAP8;
                var byteLength = romBuffer8.byteLength;
                for (var i = 0; i < byteLength; i++) {
                    gbaHeap8[startPointer8 + i] = romBuffer8[i];
                }
            };
            
            VBAInterface.renderFrame = function (pixPointer8) {
                window.vbaGraphics.drawGBAFrame(pixPointer8);
            };
            
            VBAInterface.initSound = function () {
            };
            
            VBAInterface.pauseSound = function () {
            };
            
            VBAInterface.resetSound = function () {
                window.vbaSound.resetSound();
            };
            
            VBAInterface.resumeSound = function () {
            };
            
            VBAInterface.writeSound = function (pointer8, length16) {
                return window.vbaSound.writeSound(pointer8, length16);
            };
            
            VBAInterface.setThrottleSound = function (pointer8, length16) {
            };
            
            VBAInterface.getSaveSize = function () {
                return vbaSaves.getSaveSize();
            };
            
            VBAInterface.commitFlash = VBAInterface.commitEeprom = function (pointer8, size) {
                return vbaSaves.softCommit(pointer8, size);
            };
            
            VBAInterface.restoreSaveMemory = function (pointer8, targetBufferSize) {
                return vbaSaves.restoreSaveMemory(pointer8, targetBufferSize);
            };
            
            VBAInterface.getJoypad = function (joypadNum) {
                return vbaInput.getJoypad(joypadNum);
            };
            
            VBAInterface.dbgOutput = function (textPointer8, unknownPointer8) {
                return console.log("At dbgOutput", textPointer8, unknownPointer8);
            };
            
        </script>
        <script src="./bundle.js"></script>
        <script src="./emu.js"></script>
    </head>
    <body>
        <style>
            html, body {
                font-family: sans-serif;
            }
            .ui {
                padding: 20px;
            }
            .ui-border {
                padding: 20px;
                border: 3px solid #3a3a3a;
                float: left;
                margin-bottom: 50px;
            }
            h2 {
                font-size: 14px;
            }
            p, label {
                font-size: 14px;
            }
            input[type=file] {
                position: absolute;
                left: -1000000000px;
            }
            #load-rom-from-url {
                height: 23px;
                border-radius: 3px;
                border: solid 2px black;
                margin-left: 16px;
                padding: 3px 13px;
            }
            .btn {
                display: inline-block;
                border: 4px #666fb1 solid;
                border-radius: 3px;
                padding: 8px;
                background-color: #3a3a3a;
                color: white;
                font-weight: 600;
            }
            .btn:hover {
                cursor: pointer;
                border-color: #b9bdd6;
                background-color: #7a7994;
            }
            table {
                border-collapse: collapse;
            }
            td {
                padding: 5px 15px;
                border: 2px solid #3a3a3a;
                border-top: none;
                border-bottom: none;
            }
            a {
                color: #828282;
                
            }
        </style>
        <div class="pixels"></div>
        <div style="display: none;" class="ui">
            <div class="ui-border">
                <img src="./logo.png" style="height: 50px;"/>
                <h2>Load a ROM</h2>
                <div style="padding-bottom: 10px;">
                    <label class="btn" for="load-rom-from-file">From File</label>
                    <input id="load-rom-from-file" type="file" onchange="window.loadRomFromFile(event);window.onReady('cartridge', function () {start()});"/>
                </div>
<!--
                <div>
                    <label class="btn" for="load-rom-from-url" onclick="window.loadCartridgeFromURL(event);window.onReady('cartridge', function () {start()});">From URL</label>
                    <input id="load-rom-from-url" type="text"/>
                </div>
-->
                <h2>Saves</h2>
                <p class="saves-list"></p>
                <div>
                    <label class="btn" for="import-save-file">Import Save File</label>
                    <input id="import-save-file" type="file" onchange="vbaSaves.onFileImportInputChanged(event, vbaUI.reset.bind(vbaUI));"/>
                </div>
                <h2>Keyboard Bindings</h2>
                <p class="keyboard-bindings"></p>
                <button class="btn reset-bindings-button" onclick="vbaUI.resetBindings();">Reset Bindings</button>
            </div>
        </div>
    </body>
</html>

