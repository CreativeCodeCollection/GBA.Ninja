<!DOCTYPE html>
<html>
    <head>
        
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
        
        <style>
            html, body {
                width:  100%;
                height: 100%;
                margin: 0px;
                background-color: white;
            }
            canvas {
                right: 0px;
                left: 0px;
                bottom: 0px;
                top: 0px;
                position: absolute;
                width: 100%;
                height: 100%;
            }
        </style>
        
        
        <script id="2d-vertex-shader" type="x-shader/x-vertex">
            attribute vec2 a_position;
            varying highp vec2 v_textureCoord;

            void main() {
                /* This scales the quad so that the screen texture fits the viewport. */
                gl_Position = vec4((a_position.x * 2.0 * 1.0666) - 1.0, (a_position.y * 2.0 * 1.6) * -1.0 + 1.0, 0, 1);
                v_textureCoord = vec2(a_position.x, a_position.y);
            }
        </script>

        <script id="2d-fragment-shader" type="x-shader/x-fragment">
            varying highp vec2 v_textureCoord;

            uniform sampler2D u_sampler;

            void main(void) {
                gl_FragColor = texture2D(u_sampler, vec2(v_textureCoord.s, v_textureCoord.t));
            }
        </script>
        
        <script>
            
            window.performance = window.performance || {};
            performance.now = (function () {
                return performance.now    ||
                    performance.mozNow    ||
                    performance.msNow     ||
                    performance.oNow      ||
                    performance.webkitNow ||
                    function() {
                        return new Date().getTime(); 
                    };
            })();
            
            var readyHandlers = {};
            var onReady = function (what, fn) {
                if (readyHandlers[what] === null) {
                    setTimeout(function () {fn();});
                    return;
                }
                if (readyHandlers[what] === void 0) {
                    readyHandlers[what] = [];
                }
                readyHandlers[what].push(fn);
            };
            var triggerReady = function (what) {
                console.log(what + " is ready");
                if (readyHandlers[what]) {
                    readyHandlers[what].forEach(function (v) {
                        v();
                    });
                }
                readyHandlers[what] = null;
            };
            
            
            
            
            
            var romBuffer8 = null;
            window.loadCartridge = function (url, callback) {
                if (callback) {
                    onReady("cartridge", callback);
                }
                
                var oReq = new XMLHttpRequest();
                oReq.open("GET", url, true);
                oReq.responseType = "arraybuffer";
                oReq.send(null);
                
                oReq.onload = function (oEvent) {
                    
                    var romBuffer = oReq.response;
                    romBuffer8 = new Uint8Array(romBuffer);
                    triggerReady("cartridge");
                    
                };
                
            };
            loadCartridge("./firered.gba");
            
            
            window.Module = {
                onRuntimeInitialized: function() {
                    triggerReady("emu");
                },
            };
            
            
            document.addEventListener("DOMContentLoaded", function () {
                triggerReady("document");
            });
            
            onReady("cartridge", function () {
                onReady("emu", function () {
                    onReady("document", function () {
                        triggerReady("everything");
                    });
                });
            });
            
            
            onReady("everything", function () {
                boot();
            });
            
            
            

            var boot = function () {
                
                document.body.innerHTML = '<canvas width="240" height="160"></canvas>';

                window.vbaGraphics = new VBAGraphics(window.Module, document.querySelector("canvas"));
                window.vbaGraphics.initScreen();
                window.vbaGraphics.drawFrame();
                var onResize = window.vbaGraphics.onResize.bind(window.vbaGraphics, window.innerWidth, window.innerHeight);
                window.onresize = onResize;
                onResize();
                
                window.vbaSound = new VBASound(window.Module);
                window.vbaSaves = new VBASaves(window.Module);
                window.vbaInput = new VBAInput(window.Module);

                var GBA_CYCLES_PER_SECOND = 16777216;

                VBA_start();

                window.isRunning = true;
                let lastFrameTime = Date.now();
                function eachFrame () {
                    let currentTime = Date.now();
                    let deltaTime = currentTime - lastFrameTime;
                    lastFrameTime = currentTime;
                    
                    if (!isRunning) {
                        return;
                    }
                    
                    // Static Framerate
//                    var cycles = Math.floor(Math.min(GBA_CYCLES_PER_SECOND / 60,
//                                                     (GBA_CYCLES_PER_SECOND / 1000) * deltaTime) * 1.02);
                    var timeTilNextEvent = Math.min(vbaGraphics.getTimeTilNextEvent(), vbaSound.getTimeTilNextEvent());
                    var cycles = Math.floor(timeTilNextEvent * (GBA_CYCLES_PER_SECOND));
                    VBA_do_cycles(cycles);
                    
                    vbaSaves.checkSaves();
                    
                    setTimeout(eachFrame, 0);
                };
                eachFrame();


            };
            
            
            // ------ VBA ENTRY POINTS -------
            
            var VBA_get_emulating = function () {
                return Module.ccall("VBA_get_emulating", "int", [], []);
            };
            
            var VBA_start = function () {
                return Module.ccall("VBA_start", "int", [], []);
            };
            
            var VBA_do_cycles = function (cycles) {
                return Module.ccall("VBA_do_cycles", "int", ["int"], [cycles]);
            };
            
            var VBA_stop = function () {
                return Module.ccall("VBA_stop", "int", [], []);
            };
            
            var VBA_get_bios = function () {
                return Module.ccall("VBA_get_bios", "int", [], []);
            };
            
            var VBA_get_rom = function () {
                return Module.ccall("VBA_get_rom", "int", [], []);
            };
            
            var VBA_get_internalRAM = function () {
                return Module.ccall("VBA_get_internalRAM", "int", [], []);
            };
            
            var VBA_get_workRAM = function () {
                return Module.ccall("VBA_get_workRAM", "int", [], []);
            };
            
            var VBA_get_paletteRAM = function () {
                return Module.ccall("VBA_get_paletteRAM", "int", [], []);
            };
            
            var VBA_get_vram = function () {
                return Module.ccall("VBA_get_vram", "int", [], []);
            };
            
            var VBA_get_pix = function () {
                return Module.ccall("VBA_get_pix", "int", [], []);
            };
            
            var VBA_get_oam = function () {
                return Module.ccall("VBA_get_oam", "int", [], []);
            };
            
            var VBA_get_ioMem = function () {
                return Module.ccall("VBA_get_ioMem", "int", [], []);
            };
            
            var VBA_get_systemColorMap16 = function () {
                return Module.ccall("VBA_get_systemColorMap16", "int", [], []);
            };
            
            var VBA_get_systemColorMap32 = function () {
                return Module.ccall("VBA_get_systemColorMap32", "int", [], []);
            };
            
            var VBA_get_systemFrameSkip = function () {
                return Module.ccall("VBA_get_systemFrameSkip", "int", [], []);
            };
            
            var VBA_set_systemFrameSkip = function (n) {
                return Module.ccall("VBA_set_systemFrameSkip", "int", ["int"], [n]);
            };
            
            var VBA_get_systemSaveUpdateCounter = function () {
                return Module.ccall("VBA_get_systemSaveUpdateCounter", "int", [], []);
            };
            
            var VBA_reset_systemSaveUpdateCounter = function () {
                return Module.ccall("VBA_reset_systemSaveUpdateCounter", "int", [], []);
            };
            
            var VBA_emuWriteBattery = function () {
                return Module.ccall("VBA_emuWriteBattery", "int", [], []);
            };
            
            
            
            
            // ------- VBA EXIT POINTS --------
            
            var VBAInterface = {};
            
            VBAInterface.NYI = function (feature) {
                console.log("Feature is NYI: ", feature);
            };
            
            VBAInterface.getAudioSampleRate = function () {
                return window.vbaSound.getSampleRate();
            };
            
            VBAInterface.getRomSize = function (startPointer8) {
                return romBuffer8.byteLength;
            };
            
            VBAInterface.copyRomToMemory = function (startPointer8) {
                var gbaHeap8 = Module.HEAP8;
                let byteLength = romBuffer8.byteLength;
                for (var i = 0; i < byteLength; i++) {
                    gbaHeap8[startPointer8 + i] = romBuffer8[i];
                }
            };
            
            VBAInterface.renderFrame = function (pixPointer8) {
                window.vbaGraphics.drawGBAFrame(pixPointer8);
            };
            
            VBAInterface.initSound = function () {
            };
            
            VBAInterface.pauseSound = function () {
            };
            
            VBAInterface.resetSound = function () {
                window.vbaSound.resetSound();
            };
            
            VBAInterface.resumeSound = function () {
            };
            
            VBAInterface.writeSound = function (pointer8, length16) {
                return window.vbaSound.writeSound(pointer8, length16);
            };
            
            VBAInterface.getSaveSize = function () {
                return vbaSaves.getSaveSize();
            };
            
            VBAInterface.commitFlash = VBAInterface.commitEeprom = function (pointer8, size) {
                return vbaSaves.softCommit(pointer8, size);
            };
            
            VBAInterface.restoreSaveMemory = function (pointer8, targetBufferSize) {
                return vbaSaves.restoreSaveMemory(pointer8, targetBufferSize);
            };
            
            VBAInterface.getJoypad = function (joypadNum) {
                return vbaInput.getJoypad(joypadNum);
            };
            
        </script>
        <script src="./FileSaver.js"></script>
        <script src="./Graphics.js"></script>
        <script src="./Sound.js"></script>
        <script src="./Saves.js"></script>
        <script src="./Input.js"></script>
        <script src="./emu.js"></script>
    </head>
    <body>
    </body>
</html>

